'use client'

import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Progress } from '@/components/ui/progress';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Separator } from '@/components/ui/separator';
import {
    BarChart3,
    BookOpen,
    Calendar,
    CheckCircle,
    ChevronDown,
    ChevronLeft,
    ChevronRight,
    ChevronUp,
    Clock,
    ImageOff,
    MapPin,
    Star,
    User,
    Video,
    X,
} from 'lucide-react';
import { useMemo, useState } from 'react';

// Import date-fns functions
import {
    addDays,
    addWeeks,
    endOfMonth,
    endOfWeek,
    format,
    isAfter,
    isBefore,
    isSameDay,
    isSameMonth,
    startOfMonth,
    startOfWeek
} from 'date-fns';

// Mock data for demonstration
const mockClassData = {
    title: 'Advanced Web Development',
    description: 'Master modern web development with React, Next.js, and TypeScript',
    duration_formatted: '12 weeks',
    thumbnail_url: '',
};

const mockInstructor = {
    full_name: 'Dr. Sarah Johnson',
};

const mockDifficulty = 'Intermediate';

const mockSchedules = [
    {
        uuid: '1',
        start_time: '2026-01-27T10:00:00Z',
        end_time: '2026-01-27T12:00:00Z',
        title: 'Introduction to React Hooks',
        location_type: 'ONLINE',
        status: 'SCHEDULED',
        duration_formatted: '2 hours',
        time_range: '10:00 AM - 12:00 PM',
        instructor_name: 'Dr. Sarah Johnson',
        student_attended: null,
    },
    {
        uuid: '2',
        start_time: '2026-01-29T14:00:00Z',
        end_time: '2026-01-29T16:00:00Z',
        title: 'State Management Deep Dive',
        location_type: 'ONLINE',
        status: 'SCHEDULED',
        duration_formatted: '2 hours',
        time_range: '2:00 PM - 4:00 PM',
        instructor_name: 'Dr. Sarah Johnson',
        student_attended: null,
    },
    {
        uuid: '3',
        start_time: '2026-01-24T10:00:00Z',
        end_time: '2026-01-24T12:00:00Z',
        title: 'JavaScript Fundamentals',
        location_type: 'ONLINE',
        status: 'SCHEDULED',
        duration_formatted: '2 hours',
        time_range: '10:00 AM - 12:00 PM',
        instructor_name: 'Dr. Sarah Johnson',
        student_attended: true,
    },
];

const mockLessons = [
    {
        lesson: {
            uuid: '1',
            title: 'Getting Started',
        },
        content: {
            data: [
                { uuid: 'c1', title: 'Course Overview', type: 'video' },
                { uuid: 'c2', title: 'Setup Guide', type: 'text' },
            ],
        },
    },
    {
        lesson: {
            uuid: '2',
            title: 'Core Concepts',
        },
        content: {
            data: [
                { uuid: 'c3', title: 'Components', type: 'video' },
                { uuid: 'c4', title: 'Props & State', type: 'video' },
            ],
        },
    },
];

export default function ImprovedClassPage() {
    const [showCalendar, setShowCalendar] = useState(false);
    const [selectedSchedule, setSelectedSchedule] = useState(null);
    const [showCourseProgram, setShowCourseProgram] = useState(true);
    const [expandedModules, setExpandedModules] = useState(['1']);

    const nextClass = useMemo(() => {
        const now = new Date();
        const upcoming = mockSchedules
            .filter(s => isAfter(new Date(s.start_time), now))
            .sort((a, b) => new Date(a.start_time).getTime() - new Date(b.start_time).getTime());
        return upcoming[0] || null;
    }, []);

    const toggleModule = (uuid) => {
        setExpandedModules(prev =>
            prev.includes(uuid) ? prev.filter(id => id !== uuid) : [...prev, uuid]
        );
    };

    return (
        <div className="min-h-screen bg-background">
            {/* Header */}
            <div className="border-b">
                <div className="mx-auto max-w-7xl py-4 px-6">
                    <div className="flex items-start justify-between gap-6">
                        <div className="relative h-48 w-48 overflow-hidden rounded-lg border flex-shrink-0">
                            {mockClassData.thumbnail_url ? (
                                <img
                                    src={mockClassData.thumbnail_url}
                                    alt="Course thumbnail"
                                    className="object-cover w-full h-full"
                                />
                            ) : (
                                <div className="flex h-full w-full items-center justify-center bg-muted">
                                    <ImageOff className="h-10 w-10 text-muted-foreground" />
                                </div>
                            )}
                        </div>

                        <div className="flex-1">
                            <h1 className="mb-2 text-3xl font-medium">{mockClassData.title}</h1>
                            <p className="text-muted-foreground mb-4">{mockClassData.description}</p>

                            <div className="text-muted-foreground flex items-center flex-wrap gap-6 text-sm">
                                <div className="flex items-center gap-2">
                                    <Clock className="h-4 w-4" />
                                    <span>{mockClassData.duration_formatted}</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <BarChart3 className="h-4 w-4" />
                                    <span>{mockDifficulty}</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <User className="h-4 w-4" />
                                    <span>{mockInstructor.full_name}</span>
                                </div>
                                <Button variant="outline" size="sm" className="gap-2">
                                    <Star className="h-4 w-4" />
                                    Rate Instructor
                                </Button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {/* Progress */}
            <div className="border-b">
                <div className="mx-auto max-w-7xl px-6 py-4">
                    <Progress value={35} className="mb-2 h-2" />
                    <p className="text-sm font-medium">35% completed</p>
                </div>
            </div>

            {/* Next Class Section */}
            {nextClass && (
                <div className="border-b bg-muted/30">
                    <div className="mx-auto max-w-7xl px-6 py-6">
                        <Card className="border-primary/50 bg-primary/5">
                            <CardHeader>
                                <CardTitle className="flex items-center gap-2">
                                    <Calendar className="h-5 w-5 text-primary" />
                                    Next Class Session
                                </CardTitle>
                            </CardHeader>
                            <CardContent>
                                <div className="grid gap-6 md:grid-cols-2">
                                    <div className="space-y-3">
                                        <div>
                                            <h3 className="font-semibold text-lg mb-1">{nextClass.title}</h3>
                                            <Badge variant="outline" className="mb-2">
                                                {nextClass.location_type === 'ONLINE' ? (
                                                    <><Video className="h-3 w-3 mr-1" /> Online</>
                                                ) : (
                                                    <><MapPin className="h-3 w-3 mr-1" /> Physical</>
                                                )}
                                            </Badge>
                                        </div>

                                        <div className="flex items-center gap-2 text-sm">
                                            <Calendar className="h-4 w-4 text-muted-foreground" />
                                            <span className="font-medium">
                                                {format(new Date(nextClass.start_time), 'EEEE, MMMM d, yyyy')}
                                            </span>
                                        </div>

                                        <div className="flex items-center gap-2 text-sm">
                                            <Clock className="h-4 w-4 text-muted-foreground" />
                                            <span>
                                                {format(new Date(nextClass.start_time), 'h:mm a')} - {format(new Date(nextClass.end_time), 'h:mm a')}
                                            </span>
                                            <Badge variant="secondary" className="ml-2">{nextClass.duration_formatted}</Badge>
                                        </div>

                                        <div className="flex items-center gap-2 text-sm">
                                            <User className="h-4 w-4 text-muted-foreground" />
                                            <span>{nextClass.instructor_name}</span>
                                        </div>
                                    </div>

                                    <div className="flex items-center justify-center md:justify-end">
                                        <Button size="lg" className="gap-2">
                                            <Video className="h-5 w-5" />
                                            Join Class
                                        </Button>
                                    </div>
                                </div>
                            </CardContent>
                        </Card>
                    </div>
                </div>
            )}

            {/* Main Content */}
            <div className="mx-auto max-w-7xl px-6 py-8">
                {/* Action Buttons */}
                <div className="flex gap-3 mb-6">
                    <Button
                        variant="outline"
                        onClick={() => setShowCalendar(true)}
                        className="gap-2"
                    >
                        <Calendar className="h-4 w-4" />
                        View Schedule Calendar
                    </Button>

                    <Button
                        variant="outline"
                        onClick={() => setShowCourseProgram(!showCourseProgram)}
                        className="gap-2"
                    >
                        <BookOpen className="h-4 w-4" />
                        {showCourseProgram ? 'Hide' : 'Show'} Course Program
                    </Button>
                </div>

                {/* Course Program - Collapsible */}
                {showCourseProgram && (
                    <Card className="mb-6">
                        <CardHeader className="flex flex-row items-center justify-between">
                            <CardTitle>Course Program</CardTitle>
                            <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => setShowCourseProgram(false)}
                            >
                                <X className="h-4 w-4" />
                            </Button>
                        </CardHeader>
                        <CardContent>
                            <ScrollArea className="h-[500px] pr-4">
                                <div className="space-y-3">
                                    {mockLessons.map((skill, skillIndex) => (
                                        <Collapsible
                                            key={skill.lesson.uuid}
                                            open={expandedModules.includes(skill.lesson.uuid)}
                                            onOpenChange={() => toggleModule(skill.lesson.uuid)}
                                        >
                                            <Card className="border-2 py-2.5">
                                                <CollapsibleTrigger className="w-full">
                                                    <CardHeader className="hover:bg-muted cursor-pointer py-2 transition-colors">
                                                        <div className="flex items-center justify-between">
                                                            <div className="flex items-center gap-2">
                                                                <h3 className="text-left font-medium">{skillIndex + 1}.</h3>
                                                                <h3 className="text-left font-medium">{skill.lesson.title}</h3>
                                                            </div>
                                                            {expandedModules.includes(skill.lesson.uuid) ? (
                                                                <ChevronUp className="text-muted-foreground h-5 w-5" />
                                                            ) : (
                                                                <ChevronDown className="text-muted-foreground h-5 w-5" />
                                                            )}
                                                        </div>
                                                    </CardHeader>
                                                </CollapsibleTrigger>

                                                <CollapsibleContent>
                                                    <CardContent className="pt-0">
                                                        <div className="space-y-2">
                                                            {skill.content.data.map((content) => (
                                                                <button
                                                                    key={content.uuid}
                                                                    className="border-muted flex w-full items-center justify-between rounded-lg border-2 p-3 transition-all hover:bg-muted/50"
                                                                >
                                                                    <div className="flex items-center gap-3">
                                                                        <BookOpen className="h-4 w-4 text-primary" />
                                                                        <div className="text-left">
                                                                            <p className="font-medium">{content.title}</p>
                                                                            <p className="text-muted-foreground text-sm capitalize">
                                                                                {content.type}
                                                                            </p>
                                                                        </div>
                                                                    </div>
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </CardContent>
                                                </CollapsibleContent>
                                            </Card>
                                        </Collapsible>
                                    ))}
                                </div>
                            </ScrollArea>
                        </CardContent>
                    </Card>
                )}

                {/* Weekly Schedule List */}
                <Card>
                    <CardHeader>
                        <CardTitle>This Week's Classes</CardTitle>
                    </CardHeader>
                    <CardContent>
                        <div className="space-y-3">
                            {mockSchedules.map((schedule) => {
                                const isPast = isBefore(new Date(schedule.end_time), new Date());
                                const isToday = isSameDay(new Date(schedule.start_time), new Date());

                                return (
                                    <Card
                                        key={schedule.uuid}
                                        className={`transition-all cursor-pointer hover:shadow-md ${isPast ? 'opacity-60' : ''
                                            } ${isToday ? 'border-primary/50 bg-primary/5' : ''}`}
                                        onClick={() => setSelectedSchedule(schedule)}
                                    >
                                        <CardContent className="p-4">
                                            <div className="flex items-center justify-between">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-2 flex-wrap">
                                                        <h4 className="font-semibold">{schedule.title}</h4>
                                                        {isPast && schedule.student_attended !== null && (
                                                            <Badge variant={schedule.student_attended ? 'default' : 'destructive'}>
                                                                {schedule.student_attended ? 'Attended' : 'Missed'}
                                                            </Badge>
                                                        )}
                                                        {isToday && <Badge variant="default">Today</Badge>}
                                                    </div>

                                                    <div className="flex flex-wrap gap-4 text-sm text-muted-foreground">
                                                        <div className="flex items-center gap-1">
                                                            <Calendar className="h-3 w-3" />
                                                            {format(new Date(schedule.start_time), 'EEE, MMM d')}
                                                        </div>
                                                        <div className="flex items-center gap-1">
                                                            <Clock className="h-3 w-3" />
                                                            {schedule.time_range}
                                                        </div>
                                                        <div className="flex items-center gap-1">
                                                            {schedule.location_type === 'ONLINE' ? (
                                                                <><Video className="h-3 w-3" /> Online</>
                                                            ) : (
                                                                <><MapPin className="h-3 w-3" /> Physical</>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>

                                                <ChevronRight className="h-5 w-5 text-muted-foreground flex-shrink-0" />
                                            </div>
                                        </CardContent>
                                    </Card>
                                );
                            })}
                        </div>
                    </CardContent>
                </Card>
            </div>

            {/* Calendar Dialog */}
            <Dialog open={showCalendar} onOpenChange={setShowCalendar}>
                <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
                    <DialogHeader>
                        <DialogTitle>Class Schedule Calendar</DialogTitle>
                    </DialogHeader>
                    <ClassScheduleCalendar
                        schedules={mockSchedules}
                        onScheduleClick={(schedule) => {
                            setSelectedSchedule(schedule);
                            setShowCalendar(false);
                        }}
                    />
                </DialogContent>
            </Dialog>

            {/* Schedule Details Dialog */}
            <Dialog open={!!selectedSchedule} onOpenChange={() => setSelectedSchedule(null)}>
                <DialogContent className="max-w-2xl">
                    <DialogHeader>
                        <DialogTitle>Class Session Details</DialogTitle>
                    </DialogHeader>
                    {selectedSchedule && (
                        <div className="space-y-4">
                            <div>
                                <h3 className="text-xl font-semibold mb-2">{selectedSchedule.title}</h3>
                                <div className="flex gap-2 flex-wrap">
                                    <Badge variant="outline">
                                        {selectedSchedule.location_type === 'ONLINE' ? (
                                            <><Video className="h-3 w-3 mr-1" /> Online</>
                                        ) : (
                                            <><MapPin className="h-3 w-3 mr-1" /> Physical</>
                                        )}
                                    </Badge>
                                    <Badge variant={selectedSchedule.status === 'SCHEDULED' ? 'default' : 'destructive'}>
                                        {selectedSchedule.status}
                                    </Badge>
                                </div>
                            </div>

                            <Separator />

                            <div className="grid gap-4">
                                <div className="flex items-start gap-3">
                                    <Calendar className="h-5 w-5 text-muted-foreground mt-0.5" />
                                    <div>
                                        <p className="font-medium">Date</p>
                                        <p className="text-sm text-muted-foreground">
                                            {format(new Date(selectedSchedule.start_time), 'EEEE, MMMM d, yyyy')}
                                        </p>
                                    </div>
                                </div>

                                <div className="flex items-start gap-3">
                                    <Clock className="h-5 w-5 text-muted-foreground mt-0.5" />
                                    <div>
                                        <p className="font-medium">Time</p>
                                        <p className="text-sm text-muted-foreground">
                                            {format(new Date(selectedSchedule.start_time), 'h:mm a')} - {format(new Date(selectedSchedule.end_time), 'h:mm a')}
                                            <Badge variant="secondary" className="ml-2">{selectedSchedule.duration_formatted}</Badge>
                                        </p>
                                    </div>
                                </div>

                                <div className="flex items-start gap-3">
                                    <User className="h-5 w-5 text-muted-foreground mt-0.5" />
                                    <div>
                                        <p className="font-medium">Instructor</p>
                                        <p className="text-sm text-muted-foreground">{selectedSchedule.instructor_name}</p>
                                    </div>
                                </div>

                                {selectedSchedule.student_attended !== null && (
                                    <div className="flex items-start gap-3">
                                        <CheckCircle className="h-5 w-5 text-muted-foreground mt-0.5" />
                                        <div>
                                            <p className="font-medium">Attendance</p>
                                            <Badge variant={selectedSchedule.student_attended ? 'default' : 'destructive'}>
                                                {selectedSchedule.student_attended ? 'Attended' : 'Missed'}
                                            </Badge>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {!isBefore(new Date(selectedSchedule.end_time), new Date()) && (
                                <div className="pt-4">
                                    <Button className="w-full gap-2" size="lg">
                                        <Video className="h-5 w-5" />
                                        Join Class
                                    </Button>
                                </div>
                            )}
                        </div>
                    )}
                </DialogContent>
            </Dialog>
        </div>
    );
}

function ClassScheduleCalendar({ schedules, onScheduleClick }) {
    const [currentMonth, setCurrentMonth] = useState(startOfMonth(new Date()));

    const { minMonth, maxMonth } = useMemo(() => {
        if (!schedules?.length) {
            const now = new Date();
            return {
                minMonth: startOfMonth(now),
                maxMonth: endOfMonth(now),
            };
        }

        const sorted = schedules.map(s => new Date(s.start_time)).sort((a, b) => a.getTime() - b.getTime());

        return {
            minMonth: startOfMonth(addWeeks(sorted[0], -2)),
            maxMonth: endOfMonth(addWeeks(sorted[sorted.length - 1], 2)),
        };
    }, [schedules]);

    const monthStart = startOfMonth(currentMonth);
    const monthEnd = endOfMonth(monthStart);
    const calendarStart = startOfWeek(monthStart, { weekStartsOn: 0 });
    const calendarEnd = endOfWeek(monthEnd, { weekStartsOn: 0 });

    const days = [];
    let day = calendarStart;

    while (day <= calendarEnd) {
        days.push(day);
        day = addDays(day, 1);
    }

    const prevMonth = startOfMonth(addDays(monthStart, -1));
    const nextMonth = startOfMonth(addDays(monthEnd, 1));

    const canGoPrev = prevMonth >= minMonth;
    const canGoNext = nextMonth <= maxMonth;

    const sessionsByDay = useMemo(() => {
        const map = new Map();

        schedules?.forEach((s) => {
            const key = format(new Date(s.start_time), 'yyyy-MM-dd');
            if (!map.has(key)) map.set(key, []);
            map.get(key).push(s);
        });

        return map;
    }, [schedules]);

    return (
        <Card>
            <CardHeader className="flex flex-row items-center justify-between">
                <Button
                    size="icon"
                    variant="outline"
                    disabled={!canGoPrev}
                    onClick={() => canGoPrev && setCurrentMonth(prevMonth)}
                >
                    <ChevronLeft className="h-4 w-4" />
                </Button>

                <h3 className="font-semibold">
                    {format(currentMonth, 'MMMM yyyy')}
                </h3>

                <Button
                    size="icon"
                    variant="outline"
                    disabled={!canGoNext}
                    onClick={() => canGoNext && setCurrentMonth(nextMonth)}
                >
                    <ChevronRight className="h-4 w-4" />
                </Button>
            </CardHeader>

            <CardContent>
                <div className="grid grid-cols-7 mb-2 text-xs text-muted-foreground">
                    {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
                        <div key={d} className="text-center font-medium">
                            {d}
                        </div>
                    ))}
                </div>

                <div className="grid grid-cols-7 gap-2">
                    {days.map(date => {
                        const key = format(date, 'yyyy-MM-dd');
                        const sessions = sessionsByDay.get(key) || [];
                        const isOutsideMonth = !isSameMonth(date, currentMonth);
                        const isToday = isSameDay(date, new Date());

                        return (
                            <div
                                key={key}
                                className={`min-h-[90px] rounded-md border p-1 text-xs transition-colors
                  ${isOutsideMonth ? 'bg-muted/30 text-muted-foreground' : 'bg-card'}
                  ${sessions.length ? 'border-primary/50 hover:bg-primary/5' : ''}
                  ${isToday ? 'ring-2 ring-primary' : ''}
                `}
                            >
                                <div className={`font-medium text-right ${isToday ? 'text-primary' : ''}`}>
                                    {format(date, 'd')}
                                </div>

                                <div className="space-y-1 mt-1">
                                    {sessions.map(s => {
                                        const isPast = isBefore(new Date(s.end_time), new Date());

                                        return (
                                            <button
                                                key={s.uuid}
                                                onClick={() => onScheduleClick?.(s)}
                                                className={`w-full rounded bg-primary/10 px-1 py-0.5 text-[10px] text-left hover:bg-primary/20 transition-colors ${isPast ? 'opacity-60' : ''
                                                    }`}
                                            >
                                                <div className="font-semibold truncate">
                                                    {s.title}
                                                </div>
                                                <div className="text-muted-foreground">
                                                    {format(new Date(s.start_time), 'HH:mm')}
                                                </div>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        );
                    })}
                </div>

                <p className="mt-3 text-xs text-muted-foreground text-center">
                    Showing schedule from{' '}
                    <strong>{format(minMonth, 'MMM d, yyyy')}</strong> to{' '}
                    <strong>{format(maxMonth, 'MMM d, yyyy')}</strong>
                </p>
            </CardContent>
        </Card>
    );
}