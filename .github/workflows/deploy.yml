name: "Deploy to Server"

on:
  workflow_run:
    workflows: ["Setup Server"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Self-Hosted Server
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Setup SSH Connection & Deploy
        run: |
          echo "${{ secrets.SERVER_SSH_KEY }}" > private_key
          chmod 600 private_key

          ssh -i private_key -o StrictHostKeyChecking=no "${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_IP }}" <<'EOF'
            set -e  # Exit script on error

            echo "ðŸ”‘ Logging in to GitHub Container Registry..."
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

            echo "ðŸ›‘ Stopping and removing existing containers..."
            cd ~/products/elimika-ui/docker
            docker compose -f compose.yaml down --remove-orphans

            echo "ðŸš€ Pulling latest Docker image..."
            docker compose -f compose.yaml pull

            echo "ðŸš€ Starting the application with latest image..."
            docker compose -f compose.yaml up -d

            echo "âœ… Deployment complete!"
          EOF